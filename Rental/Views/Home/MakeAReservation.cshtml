<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h1>Make a reservation</h1>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <div id="app">
                <div class="row">
                    <div class="col-md-6">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="row">
                                    <label>Car:</label>
                                    <select id="car" class="form-control" v-model="indexCar">
                                        <option v-for="item in cars" :value="item.carId">{{item.licenseNumber}}</option>
                                    </select>
                                </div>
                                <div class="row" v-if="showForm">
                                    <label>Start date:</label>
                                    <input type="date" class="form-control" v-model="form.startDate" />
                                </div>
                                <div class="row" v-if="showForm">
                                    <label>End date:</label>
                                    <input type="date" class="form-control" v-model="form.endDate" />
                                </div>
                                <div class="row" v-if="showForm">
                                    <label>Observations:</label>
                                    <textarea class="form-control" v-model="form.observations"></textarea>
                                </div>
                                <div class="row" v-if="showForm" style="margin-top:20px;">
                                    <button class="form-control" v-on:click="submit">Submit Reservation</button>
                                    <span id="error" style="color:red">{{error}}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <img style="max-width:576px; max-height: 324px" id="img" src="" />
                    </div>
                </div>
                <div class="row" style="margin-top:20px;">
                    <div class="col-md-12">
                        <div id="calendar"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    new Vue({
        el: "#app",
        data: {
            cars: [],
            error: "",
            indexCar: 0,
            form: {
                startDate: moment().format("YYYY-MM-DD"),
                endDate: moment().format("YYYY-MM-DD"),
                observations: "",
                index: 0
            },
            showForm: false,
            message: "Hello from Vue"
        },
        mounted() {
            let self = this;
            $.ajax({
                "crossDomain": true,
                "url": "http://localhost:55576/api/getCars",
                "method": "GET"
            }).done(function (response) {
                if (response.status) {
                    self.cars = response.data
                }
                });
            $("#calendar").fullCalendar({
                defaultDate: new Date(),
                navLinks: false, // can click day/week names to navigate views
                editable: false,
                displayEventEnd: true,
                selectable: true,
                height: 450
                });
        },
        methods: {
            submit() {
                let self = this
                if (this.form.startDate > this.form.endDate || this.form.startDate == this.form.endDate) {
                    this.error = "Invalid dates!"
                    return
                }
                if (this.form.endDate === "" && this.form.startDate === "") {
                    this.error = "Complete reservation date interval"
                    return
                }
                if (this.form.startDate === "") {
                    this.error = "Complete start date!"
                    return
                }
                if (this.form.endDate === "") {
                    this.error = "Complete end date!"
                    return
                }
                $.ajax({
                    "crossDomain": true,
                    "url": "http://localhost:55576/api/setReservation",
                    "method": "POST",
                    "data": {
                        'start': this.form.startDate,
                        'end': this.form.endDate,
                        'observations': this.form.observations,
                        'car': this.form.index
                    }
                }).done(function (response) {
                    if (response) {
                        for (let i = 0; i < self.cars.length; i++) {
                            if (self.cars[i].carId == self.form.index) {
                                var source = [{
                                    'start': self.form.startDate,
                                    'end': self.form.endDate,
                                    'title': 'New reservation'
                                }]
                                for (let j = 0; j < self.cars[i].reservations.length; j++) {
                                    var obj = {
                                        'title': 'Reservated',
                                        'start': self.cars[i].reservations[j].startDate,
                                        'end': self.cars[i].reservations[j].endDate,
                                    }
                                    source.push(obj)
                                }
                                $('#calendar').fullCalendar('removeEvents')
                                $("#calendar").fullCalendar('addEventSource', source)

                                self.form = {
                                    startDate: moment().format("YYYY-MM-DD"),
                                    endDate: moment().format("YYYY-MM-DD"),
                                    observations: "",
                                    index: self.form.index
                                }
                                self.error = ""
                            }
                        }
                    } else {
                        self.error = "Your reservation overlaps with an existing one!"
                    }
                });
                $("#calendar").fullCalendar({
                    defaultDate: new Date(),
                    navLinks: false, // can click day/week names to navigate views
                    editable: false,
                    displayEventEnd: true,
                    selectable: true,
                    height: 450
                });
            }
        },
        watch: {
            indexCar: function (val) {
                this.form.index = val
                for (let i = 0; i < this.cars.length; i++) {
                    if (this.cars[i].carId == val) {
                        $("#img").attr("src", this.cars[i].carType.image);
                        this.showForm = true;
                        var source = []
                        for (let j = 0; j < this.cars[i].reservations.length; j++) {
                            var obj = {
                                'title': 'Reservated',
                                'start': this.cars[i].reservations[j].startDate,
                                'end': this.cars[i].reservations[j].endDate,
                            }
                            source.push(obj)
                        }
                        $('#calendar').fullCalendar('removeEvents')
                        $("#calendar").fullCalendar('addEventSource', source)
                    }
                }
            }
        }
    })
</script>